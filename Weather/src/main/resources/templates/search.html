<!-- search.html -->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì§€ì—­ ë‚ ì”¨ ê²€ìƒ‰</title>

    <style>
        /* ê²€ìƒ‰ ë°•ìŠ¤ë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ */
        .search-box {
            position: relative;
            width: 300px;
        }

        /* ìë™ì™„ì„± ë°•ìŠ¤ */
        .suggest-box {
            position: absolute;
            top: 100%;          /* input ë°”ë¡œ ì•„ë˜ */
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            z-index: 100;
        }

        .suggest-box.hidden {
            display: none;
        }

        .suggest-item {
            padding: 8px 10px;
            cursor: pointer;
        }

        .suggest-item:hover {
            background: #f3f3f3;
        }

        .suggest-region {
            font-weight: 500;
        }

        .suggest-sub {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>

<h2>ì§€ì—­ ê²€ìƒ‰</h2>

<!-- ğŸ” ê²€ìƒ‰ í¼ (ê¸°ì¡´ì²˜ëŸ¼ ì—”í„°/ë²„íŠ¼ ê²€ìƒ‰ë„ ê°€ëŠ¥) -->
<form th:action="@{/search}" method="get" autocomplete="off">
    <div class="search-box">
        <input id="region-input"
               type="text"
               name="q"
               placeholder="ì˜ˆ) ì„œìš¸, ì¢…ë¡œ, ì¸ì²œ ì„œêµ¬"
               th:value="${keyword}">
        <button type="submit">ê²€ìƒ‰</button>

        <!-- â¬‡ï¸ ìë™ì™„ì„± ë°•ìŠ¤ -->
        <div id="suggest-box" class="suggest-box hidden">
            <ul id="suggest-list"></ul>
        </div>
    </div>
</form>

<hr/>

<!-- ğŸ” í•˜ë‹¨ ì „ì²´ ê²€ìƒ‰ ê²°ê³¼(ë²„íŠ¼/ì—”í„° ëˆŒë €ì„ ë•Œ) -->
<div th:if="${results != null}">
    <p th:if="${#lists.isEmpty(results)}">
        ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
    </p>

    <ul th:if="${!#lists.isEmpty(results)}">
        <li th:each="r : ${results}">
            <a th:href="@{/{city}/{district}(city=${r.parentRegion}, district=${r.childRegion})}"
               th:text="${r.parentRegion} + ' ' + ${r.childRegion}">
            </a>
        </li>
    </ul>
</div>

<script>
    const input = document.getElementById('region-input');
    const suggestBox = document.getElementById('suggest-box');
    const suggestList = document.getElementById('suggest-list');

    // ì…ë ¥í•  ë•Œë§ˆë‹¤ ìë™ì™„ì„± ìš”ì²­
    input.addEventListener('input', async (e) => {
        const q = e.target.value.trim();

        if (q.length === 0) {
            hideSuggest();
            return;
        }

        try {
            const res = await fetch('/search/suggest?q=' + encodeURIComponent(q));
            if (!res.ok) {
                hideSuggest();
                return;
            }
            const data = await res.json();   // [{parentRegion: "...", childRegion: "..."}, ...]

            renderSuggest(data);
        } catch (err) {
            console.error(err);
            hideSuggest();
        }
    });

    function renderSuggest(items) {
        suggestList.innerHTML = '';

        if (!items || items.length === 0) {
            hideSuggest();
            return;
        }

        items.forEach((r) => {
            const li = document.createElement('li');
            li.className = 'suggest-item';

            const main = document.createElement('div');
            main.className = 'suggest-region';
            main.textContent = r.parentRegion + ' ' + r.childRegion;

            const sub = document.createElement('div');
            sub.className = 'suggest-sub';
            sub.textContent = 'ë‚ ì”¨ ë³´ê¸°';

            li.appendChild(main);
            li.appendChild(sub);

            // í´ë¦­í•˜ë©´ /{city}/{district} ë¡œ ì´ë™
            li.addEventListener('click', () => {
                const city = encodeURIComponent(r.parentRegion);
                const district = encodeURIComponent(r.childRegion);
                window.location.href = `/${city}/${district}`;
            });

            suggestList.appendChild(li);
        });

        showSuggest();
    }

    function showSuggest() {
        suggestBox.classList.remove('hidden');
    }

    function hideSuggest() {
        suggestBox.classList.add('hidden');
    }

    // input í¬ì»¤ìŠ¤ë¥¼ ë²—ì–´ë‚˜ë©´ ë°•ìŠ¤ë¥¼ ë‹«ê³  ì‹¶ìœ¼ë©´ ì´ ì •ë„ë„ ì¶”ê°€ ê°€ëŠ¥
    input.addEventListener('blur', () => {
        setTimeout(hideSuggest, 150); // í´ë¦­ ì´ë²¤íŠ¸ ë¨¼ì € ì²˜ë¦¬ í›„ ë‹«íˆë„ë¡ ì‚´ì§ ë”œë ˆì´
    });
</script>

</body>
</html>
